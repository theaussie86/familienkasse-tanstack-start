openapi: 3.1.0
info:
  title: Familienkasse API - Data Migration & Allowance Extensions
  version: 2.0.0
  description: |
    API contract extensions for the Data Migration & Weekly Allowance feature.
    Extends existing account endpoints with recurring allowance configuration.

servers:
  - url: http://localhost:3000
    description: Development server

components:
  schemas:
    AllowanceConfig:
      type: object
      properties:
        recurringAllowanceEnabled:
          type: boolean
          description: Whether weekly allowance is enabled for this account
          example: true
        recurringAllowanceAmount:
          type: integer
          description: Weekly allowance amount in cents (e.g., 500 = €5.00)
          minimum: 0
          example: 500
      required:
        - recurringAllowanceEnabled
        - recurringAllowanceAmount

    Account:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        name:
          type: string
          example: "Max's Account"
        userId:
          type: string
          format: uuid
        recurringAllowanceEnabled:
          type: boolean
          example: false
        recurringAllowanceAmount:
          type: integer
          minimum: 0
          example: 0
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - name
        - userId
        - recurringAllowanceEnabled
        - recurringAllowanceAmount
        - createdAt
        - updatedAt

    AccountUpdate:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        recurringAllowanceEnabled:
          type: boolean
        recurringAllowanceAmount:
          type: integer
          minimum: 0
      description: All fields are optional. Only provided fields will be updated.

    CronResult:
      type: object
      properties:
        success:
          type: boolean
        accountsProcessed:
          type: integer
          description: Number of accounts that received allowances
        accountsSkipped:
          type: integer
          description: Number of accounts skipped (disabled, zero amount, or already processed)
        errors:
          type: array
          items:
            type: string
          description: Any error messages encountered during processing
      required:
        - success
        - accountsProcessed
        - accountsSkipped

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code for client handling
      required:
        - error

  securitySchemes:
    sessionAuth:
      type: apiKey
      in: cookie
      name: better-auth.session_token
      description: Better-Auth session cookie

security:
  - sessionAuth: []

paths:
  /api/accounts/{accountId}:
    get:
      summary: Get account with allowance configuration
      description: |
        Returns account details including the new recurring allowance fields.
        User can only access their own accounts.
      tags:
        - Accounts
      parameters:
        - name: accountId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Account details with allowance configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Account belongs to another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      summary: Update account including allowance configuration
      description: |
        Updates account fields. Supports partial updates - only provided fields are modified.
        New fields: recurringAllowanceEnabled, recurringAllowanceAmount
      tags:
        - Accounts
      parameters:
        - name: accountId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AccountUpdate'
            examples:
              enableAllowance:
                summary: Enable weekly €5 allowance
                value:
                  recurringAllowanceEnabled: true
                  recurringAllowanceAmount: 500
              disableAllowance:
                summary: Disable allowance (keeps amount)
                value:
                  recurringAllowanceEnabled: false
              updateAmountOnly:
                summary: Change allowance amount
                value:
                  recurringAllowanceAmount: 1000
      responses:
        '200':
          description: Updated account
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Account belongs to another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Account not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/cron/weekly-allowance:
    post:
      summary: Trigger weekly allowance processing (Admin/System only)
      description: |
        Manually triggers the weekly allowance cron job. Intended for:
        - Testing during development
        - Manual recovery if scheduled run failed

        In production, this is automatically triggered by Nitro scheduled tasks.

        **Security**: This endpoint should be protected and only accessible to administrators
        or the system scheduler.
      tags:
        - Cron
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                dryRun:
                  type: boolean
                  default: false
                  description: If true, simulate the run without creating transactions
      responses:
        '200':
          description: Cron job completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CronResult'
              examples:
                success:
                  summary: Successful run
                  value:
                    success: true
                    accountsProcessed: 3
                    accountsSkipped: 2
                    errors: []
                partialFailure:
                  summary: Some accounts failed
                  value:
                    success: true
                    accountsProcessed: 2
                    accountsSkipped: 1
                    errors:
                      - "Account abc123: Failed to create transaction"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not authorized (requires admin role)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Cron job failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

tags:
  - name: Accounts
    description: Family account management (extended with allowance config)
  - name: Cron
    description: Scheduled task endpoints
